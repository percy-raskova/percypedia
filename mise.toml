# mise.toml - PercyBrain Sphinx Build Tasks
# Usage: mise run <task>
# Note: Uses .venv binaries directly (no source needed)

[tools]
python = "3.13"

[env]
SPHINX_SOURCE = "."
SPHINX_BUILD = "_build"
# Add venv to PATH for all tasks
PATH = "{{cwd}}/.venv/bin:{{env.PATH}}"

[tasks.build]
run = "sphinx-build -b html . _build/html"
description = "Build HTML documentation"

[tasks.clean]
run = "rm -rf _build"
description = "Clean build artifacts"

[tasks.watch]
run = "sphinx-autobuild . _build/html --port 8000"
description = "Auto-rebuild on changes (no browser)"

[tasks.preview]
run = "sphinx-autobuild . _build/html --port 8000 --open-browser"
description = "Live preview with auto-open browser"

[tasks.linkcheck]
run = "sphinx-build -b linkcheck . _build/linkcheck"
description = "Check for broken links"

[tasks.serve]
run = "python -m http.server 8000 -d _build/html"
description = "Serve built docs locally"

[tasks.pdf]
run = "sphinx-build -b latex . _build/latex && make -C _build/latex"
description = "Build PDF via LaTeX"

[tasks.deps]
run = "pip install -r requirements.txt"
description = "Install Python dependencies"

[tasks.ci]
run = "pip install -r requirements.txt && sphinx-build -b html . _build/html"
description = "CI build (install deps + build)"

[tasks.test]
run = "pytest"
description = "Run extension tests"

[tasks."test:watch"]
run = "pytest --tb=short -x"
description = "Run tests (stop on first failure)"

# Frontmatter Normalizer Tasks
[tasks."fm:setup"]
run = "pip install spacy click rapidfuzz && python -m spacy download en_core_web_lg"
description = "Install frontmatter normalizer dependencies + SpaCy model"

[tasks."fm:report"]
run = "python -m frontmatter_normalizer report ."
description = "Report on frontmatter status"
dir = "_tools"

[tasks."fm:dry-run"]
run = "python -m frontmatter_normalizer normalize --dry-run --verbose ."
description = "Dry run frontmatter normalization"
dir = "_tools"

[tasks."fm:normalize"]
run = "python -m frontmatter_normalizer normalize ."
description = "Normalize all frontmatter (creates backups)"
dir = "_tools"

[tasks."fm:validate"]
run = "python -m frontmatter_normalizer validate ."
description = "Validate frontmatter against schema"
dir = "_tools"

[tasks."fm:test"]
run = "pytest frontmatter_normalizer/ -v"
description = "Run frontmatter normalizer tests"
dir = "_tools"
env = { PYTHONPATH = "{{cwd}}/_tools" }

[tasks."fm:test:short"]
run = "pytest frontmatter_normalizer/ --tb=no -q"
description = "Run tests with condensed output"
dir = "_tools"
env = { PYTHONPATH = "{{cwd}}/_tools" }

[tasks."fm:compare"]
run = "python -m frontmatter_normalizer.compare_classifiers"
description = "Compare SpaCy vs Sentence Transformers classification"
dir = "_tools"
env = { PYTHONPATH = "{{cwd}}/_tools" }
